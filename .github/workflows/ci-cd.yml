name: CI/CD Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      PROJECT_ID: ohzbghitbjryfpmucgju
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Supabase project
        run: supabase link --project-ref $PROJECT_ID

      - name: Check migration status
        run: |
          echo "Checking current migration status..."
          supabase migration list

      - name: Reset migration history for clean deployment
        run: |
          echo "Resetting migration history for clean deployment..."
          # Mark all old migrations as reverted to clean up the migration history
          # This allows our new consolidated migrations to be applied cleanly
          supabase migration repair --status reverted 20251016000001 20251016000002 20251016000003 20251016000004 20251016000005 20251016000007 20251016000008 20251016000009 20251016000010 20251016000011 20251016000012 20251016000013 20251016000014 20251016000015 20251017000001 20251018000001 20251018000002 20251018000003 20251018000004 20251018000005 20251019000001 20251019000002 20251019000003 20251019000004 20251019000005 20251019000006 20251019000007 20251019000008 20251019000009 20251020000001 20251020000002 20251020000003 20251020000004 20251021000001 20251021000002 || echo "Migration repair completed or not needed"

      - name: Run database migrations
        run: |
          echo "Applying consolidated migrations..."
          supabase db push --yes

      - name: Verify migrations were applied
        run: |
          echo "Final migration status:"
          supabase migration list

      - name: Remove unwanted functions
        run: |
          echo "Removing unwanted edge functions..."
          # Remove the 'server' function if it exists
          supabase functions delete server --project-ref $PROJECT_ID || echo "Server function not found or already removed"

      - name: Deploy Supabase functions
        run: supabase functions deploy --project-ref $PROJECT_ID
